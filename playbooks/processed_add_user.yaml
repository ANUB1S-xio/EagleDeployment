name: "Basic_Add_Users"
version: "2.1"
hosts:
  - "10.42.56.100"
  - "10.42.56.101"
vars:
  SSHCred:
    ssh_user: "eagleadmin"
    ssh_pass: "@dminPass123"
  user_name: "steve"
  user_password: "ComplexP@ssw0rd!"
tasks:
  - name: "Add user steve on Linux systems"
    ssh_user: "eagleadmin"
    ssh_password: "@dminPass123"
    port: 22
    when: item.OS in ["Linux", "Ubuntu", "Fedora"]
    loop: "[{10.42.56.100  Linux
} {10.42.56.101  Linux
}]"
    loop_control:
      loop_var: item
    command: |
      echo "@dminPass123" | sudo -S useradd -m -s /bin/bash steve

  - name: "Add user steve on Windows systems"
    ssh_user: "eagleadmin"
    ssh_password: "@dminPass123"
    port: 22
    when: item.OS in ["Windows"]
    loop: "[{10.42.56.100  Linux
} {10.42.56.101  Linux
}]"
    loop_control:
      loop_var: item
    command: |
      net user steve ComplexP@ssw0rd! /add

  - name: "Pause to ensure user creation"
    command: sleep 2

  - name: "Verify user steve exists on Linux systems"
    ssh_user: "eagleadmin"
    ssh_password: "@dminPass123"
    port: 22
    when: item.OS in ["Linux", "Ubuntu", "Fedora"]
    loop: "[{10.42.56.100  Linux
} {10.42.56.101  Linux
}]"
    loop_control:
      loop_var: item
    command: id steve
    register: user_exists
    ignore_errors: true

  - name: "Verify user steve exists on Windows systems"
    ssh_user: "eagleadmin"
    ssh_password: "@dminPass123"
    port: 22
    when: item.OS in ["Windows"]
    loop: "[{10.42.56.100  Linux
} {10.42.56.101  Linux
}]"
    loop_control:
      loop_var: item
    command: net user steve
    register: user_exists
    ignore_errors: true

  - name: "Set password for user steve on Linux systems"
    ssh_user: "eagleadmin"
    ssh_password: "@dminPass123"
    port: 22
    when: item.OS in ["Linux", "Ubuntu", "Fedora"] and user_exists.rc == 0
    loop: "[{10.42.56.100  Linux
} {10.42.56.101  Linux
}]"
    loop_control:
      loop_var: item
    command: |
      echo "@dminPass123" | sudo -S bash -c "echo 'steve:ComplexP@ssw0rd!' | chpasswd"

  - name: "Set password for user steve on Windows systems"
    ssh_user: "eagleadmin"
    ssh_password: "@dminPass123"
    port: 22
    when: item.OS in ["Windows"] and user_exists.rc == 0
    loop: "[{10.42.56.100  Linux
} {10.42.56.101  Linux
}]"
    loop_control:
      loop_var: item
    command: |
      net user steve ComplexP@ssw0rd!

settings:
  port: 22
